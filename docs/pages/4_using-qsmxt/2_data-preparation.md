---
layout: default
title: Data preparation
nav_order: 2
parent: Using QSMxT
permalink: /using-qsmxt/data-preparation
---

<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

# Data preparation

QSMxT requires <a href="https://bids.neuroimaging.io/" target="_blank" data-placement="top" data-toggle="popover" data-trigger="hover focus" data-content="Click to read about BIDS at https://bids.neuroimaging.io/.">BIDS</a>-organised data. If your data is not prepared according to the BIDS specification, see the steps below according to your needs:

## I have unsorted DICOMs

To convert to BIDS, your DICOM data must at least be sorted within subject, session and series folders. To sort your DICOM data, run the following, replacing `YOUR_DICOM_DIR` with your DICOM directory, and `dicoms_sorted` with your preferred output directory. If the output directory does not exist, it will be created.

```bash
python3 /opt/QSMxT/run_0_dicomSort.py YOUR_DICOM_DIR dicoms_sorted
```
<script>
$(function(){
    $('#text').load('/qsmxt.github.io/index #TEST');
});
</script>

## I have sorted DICOMs

If your DICOM data is sorted within subject, session and series folders, you can convert to BIDS using the following:

```bash
python3 /opt/QSMxT/run_1_dicomConvert.py SORTED_DICOM_DIR bids
```

Since DICOM headers do not describe contrast weighting in a standardised way (e.g. T1-weighted, T2\*-weighted, FLAIR, etc), QSMxT will try to identify the weighting based on the `ProtocolName` DICOM field. Images with a `ProtocolName` matching any of `[*qsm*, *gre*, *epi*]` will be considered T2\*-weighted, and those matching `[*t1w*]` will be considered T1-weighted. Alternate `ProtocolName` patterns can be specified using command-line arguments (see `run_1_dicomConvert.py --help`).

In addition to the weighting, QSMxT will also attempt to identify run numbers based on the order of the `SeriesNumber` field, echo numbers based on chronology of the `EchoTime` fields, and whether a series represents phase or magnitude data based on whether the `ImageType` field contains a `'P'` entry.

## I have NIfTI files

NIfTI files store insufficient information in their header for a complete conversion to BIDS. However, for QSMxT, we only need the image weighting (T2\*-weighted or T1-weighted), field strength, run numbers, echo numbers, echo times, and image types (magnitude or phase). If your NIfTI data contains some of this information in the file path or in an adjacent JSON header (generated by dcm2niix), the `run_1_niftiConvert.py` script will automatically attempt to extract this information using customisable match patterns and regular expresions. Use the following command to start the conversion from NIfTI:

```bash
python3 /opt/QSMxT/run_1_niftiConvert.py YOUR_NIFTI_DIR bids
```

If any information is missing for the conversion to take place, a spreadsheet (CSV file) will be written for you to provide it. You can use a spreadsheet editor such as Microsoft Excel or LibreOffice Calc to do this. Then, run the same command again and the conversion should complete. Alternatively, you can customise the match patterns and regular expressions to improve the extraction of information (see `run_1_niftiConvert.py --help` for details).

<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover();   
});
$("[data-toggle=popover]")
.popover({html:true})
</script>

