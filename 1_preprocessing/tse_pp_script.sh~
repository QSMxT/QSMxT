#!/bin/bash

#this is the tse_preprocessing script for qsm28 dataset
#Thomas Shaw 5/4/18 
#skull strip, bias correct, interpolate, then prepare for nlin/lin MC (different script)
#also includes TSE_MEAN from scanner now as run-mean TSE.

subjName=$1
#for subjName in sub-201505181502S16SB sub-201506121055S15LS ; do
    source ~/.bashrc
    export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=4
    export NSLOTS=4
    module load freesurfer/6.0
    module load singularity/2.4.2
    singularity="singularity exec /30days/uqtshaw/fsl_ants_robex_20180312.simg"
    bidsdir=/30days/uqtshaw
    ss="ses-01"
    t1w=$bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T1w.nii.gz
    tse1=$bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-1_tse.nii.gz
    tse2=$bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-2_tse.nii.gz
    tse3=$bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-3_tse.nii.gz
    tsemean=$bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-mean_tse.nii.gz
    deriv=/$bidsdir/derivatives
    mkdir -p /30days/uqtshaw/derivatives/tse_preprocessing/${subjName}/
#cd /30days/uqtshaw/derivatives/tse_preprocessing/${subjName}/
    echo $subjName
    echo $t1w

#skull strip

    $singularity runROBEX.sh $t1w $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brain_preproc.nii.gz $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brainmask_preproc.nii.gz

#apply mask to tse - resample like tse
    $singularity flirt -v -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brainmask_preproc.nii.gz -ref $tse1 -applyxfm -usesqform -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-1_brainmask_preproc.nii.gz
    $singularity flirt -v -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brainmask_preproc.nii.gz -ref $tse2 -applyxfm -usesqform -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-2_brainmask_preproc.nii.gz
    $singularity flirt -v -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brainmask_preproc.nii.gz -ref $tse3 -applyxfm -usesqform -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-3_brainmask_preproc.nii.gz
    $singularity flirt -v -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T1w_brainmask_preproc.nii.gz -ref $tsemean -applyxfm -usesqform -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-mean_brainmask_preproc.nii.gz


    if [[ ! -e $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-1_brainmask_N4corrected_preproc.nii.gz ]] ; then
#Bias correction - use mask created - 
    	for x in "1" "2" "3" "mean"; do
	    #try flirt mask to tse for case by case fails
	    #$singularity flirt -v -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_brainmask_preproc.nii.gz -ref $bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-${x}_tse.nii.gz -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_brainmask_preproc.nii.gz

#nomask N4
	    $singularity N4BiasFieldCorrection -d 3 -b [1x1x1,3] -c '[50x50x40x30,0.00000001]' -i $bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-${x}_tse.nii.gz -r 1 -o $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_preproc.nii.gz --verbose 1 -s 2 
#MASKED $singularity N4BiasFieldCorrection -d 3 -b [1x1x1,3] -c '[50x50x40x30,0.00000001]' -i $bidsdir/$subjName/$ss/anat/${subjName}_${ss}_T2w_run-${x}_tse.nii.gz -x $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_brainmask_preproc.nii.gz -r 1 -o $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_preproc.nii.gz --verbose 1 -s 2 

#mask the bias corrected TSE.
	    $singularity fslmaths $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_preproc.nii.gz -mul $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_brainmask_preproc.nii.gz $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_brain_preproc.nii.gz 
	    
	#interpolation of brainmasked and non-masked TSEs
	    $singularity flirt -v -applyisoxfm 0.3 -interp sinc -sincwidth 8 -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_preproc.nii.gz -ref $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_preproc.nii.gz -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_res-iso.3_N4corrected_preproc.nii.gz
	    $singularity flirt -v -applyisoxfm 0.3 -interp sinc -sincwidth 8 -in $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_brain_preproc.nii.gz -ref $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_N4corrected_brain_preproc.nii.gz -out $deriv/tse_preprocessing/$subjName/${subjName}_${ss}_T2w_run-${x}_res-iso.3_N4corrected_brain_preproc.nii.gz
	done
    fi
#loop subjNames....
#done